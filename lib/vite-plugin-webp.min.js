/*!
 * vite-plugin-webp v1.1.1
 * (c) Wed Feb 01 2023 14:08:16 GMT+0800 (China Standard Time) luchuanqi
 * Released under the MIT License.
 */
"use strict";var e=require("fs"),t=require("path"),r=require("sharp");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=n(e),o=n(t),a=n(r);function c(e){try{return window.eval(e)}catch(t){return e}}var s={toArray:function(e){return"string"==typeof e?e?[e]:[]:e},isDirectory:function(e){return i.default.statSync(e).isDirectory()},evalCatch:c,isTargetImage:function(e,t){const r=c(e).split("."),n=r[r.length-1];return t.includes(`.${n}`)},getWebpPath:function(e,t,r,n){const i=e.split("."),o=i[i.length-1],a=new RegExp(`${o}$`),c=new RegExp(`${t}`,"g");return e.replace(a,n).replace(c,r)}};const l=/\D+(\d+)[xX*](\d+)\.webp$/;function u(e,t){if(!1===i.default.existsSync(e))return;const{imageType:r,entry:n,outDir:c,sharpType:p}=t;i.default.readdirSync(e).forEach((i=>{const f=o.default.join(e,i);s.isDirectory(f)?u(f,t):s.isTargetImage(f,r)&&(Array.isArray(p)?p.forEach((e=>{const t=s.getWebpPath(f,n,c,e);console.log("生产"),console.log(t),((e,t,r)=>{let n=null,i=null;l.lastIndex=0,l.test(t)&&(n=Number(RegExp.$1),i=Number(RegExp.$2)),new Promise(((o,c)=>{if("avif"===r)try{a.default(e).resize({width:n,height:i}).avif().toFile(t,((e,t)=>{e?c(e):o(t)}))}catch(e){c(e)}else try{a.default(e).resize({width:n,height:i}).webp().toFile(t,((e,t)=>{e?c(e):o(t)}))}catch(e){c(e)}}))})(f,t,e)})):console.error("sharpType需为数组"))}))}const p=e=>{const{entry:t}=e,r=s.toArray(t);for(let t=0;t<r.length;t++){u(r[t],e)}};module.exports=function(e={}){const t=Object.assign({entry:"",imageType:[".png",".jpg"],sharpType:["webp"],outDir:"",compileTime:"after"},e);return"before"===t.compileTime&&p(t),{name:"vite-plugin-sharp",enforce:"post",closeBundle(){"after"===t.compileTime&&(p(t),console.info("编译结束"))}}};
